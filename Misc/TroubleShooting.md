# トラブルシューティング / Trouble shooting  
MP Version: v.230809  
## なんも言わずに落ちる / Game crashes without any notification  
### 解決指針  
**v[v[n]+v[m]]のような形で複数の変数を組み合わせて変数番号変数を参照している処理**が壊れている可能性が高い。  
そのような処理を見直してみるとよい。  
  
### 理由  
- 変数番号変数等をいじくって複雑な処理を作っていると、ときおり何の警告文もなくクラッシュすることがある。  
この類型のクラッシュは、ほとんどの場合は不正なポインタ変数によって数字の大きい変数番地が参照された場合に生じていると思われる。  
例えば下記の処理を試してみるとわかりやすい:  
```
v[1] = 999999990
v[2] = 999999990
v[3] = 999999990
v[v[1]+v[2]+v[3]] = 1
```
筆者は内部挙動の解析をしていないため、推測による記載となるが、**ツクールはある変数番地が初めて参照された場合、その番地までの変数のメモリを一気に確保する**と思われる。  
その際、一度に確保する数量があまりに膨大であるとクラッシュを引き起こすことがある。  
また、RPG_RT.exeが確保しようとするメモリの量が、実行環境の割り当て可能なメモリ上限を越えてしまっても同様の形でクラッシュする。  
~~よって、このようなクラッシュに直面した際は、ポインタの関係する処理を見直すとよい。~~  
64bit版では、異常な数値が代入された変数を用いて変数番号変数を参照しても、それだけでは環境次第ではクラッシュしなくなった。  
これはMPの変数が符号付き32bit intであるから、正の値で取りうる最大の数で番地を参照してメモリ確保しても、その確保量は最大で4GB程度にとどまるためである。  
  
しかし、ツクール上の変数が32bit intなだけであって、内部処理自体は64bitで行われているため、  
式を用いると符号付き32bit intが指し示せる限界を越えた番地を参照することはできてしまう。  
そのようなことが起きた場合には、依然として無言でのクラッシュが生じうる。  
複数の変数を組み合わせて変数番号変数を参照する例中`v[v[1]+v[2]+v[3]]`のような処理では特に生じやすいため、注意したほうがよい。  
  
- また、ゲーム内で大量の変数を扱う場合、ゲームの初期化イベント等において事前にメモリ領域確保のための処理を挟んでおく必要があ~~る~~った。  
*(64bit化した現在はどうやらクラッシュしなそうなため、今も必要かは微妙なところ。  
が、確保の際に一定の負荷がかかるため、事前に確保処理を挟んでおくことをおすすめする)*  
  
といっても、そのようなコマンドがあるわけではないし、複雑な変数操作を伴うものでもない。  
以下はDIS:Legacyにおいて行っている処理を簡略化したものであるが、たったこれだけでメモリ事前確保は済む:  
```
v[1266] = 1500001
v[v[1268]] = 0  
```  
  
DIS:Legacyでは200万個程度の変数領域を起動時に確保しており、  
さらに初期化時に読み込んだ領域末尾以降を配列初期化時に用いる0の配列として利用している。  
普通にRPG等を作る上で使う変数の量に鑑みるととんでもない量の変数を確保しているわけだが、  
こうして事前確保しておけば、処理が正常である限りはクラッシュしない。~~処理が正常であるとは限らないが~~  
  
- メモリ確保のデメリット  
当然のことだが、メモリ領域確保がなされるとRPG_RT.exeの消費メモリ容量は増える。  
また、ツクールデフォルトのセーブは確保した領域全てを保存しているようで、セーブファイルに書き込まれるデータ量も増え、セーブファイルが肥大化する。  
